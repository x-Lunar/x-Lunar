<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>x-Lunar's Projects</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load p5.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            /* Added overflow-hidden to prevent body scroll during transitions */
            overflow-x: hidden;
        }
        .card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }
        .nav-button {
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        }
        .nav-button:hover {
            transform: translateY(-1px);
        }
        
        /* Content view transition styles */
        .content-view {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out, max-height 0.4s ease-in-out;
            transform: translateY(10px);
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            visibility: hidden; /* Use visibility to prevent interaction when hidden */
        }
        .content-view.active {
            transform: translateY(0);
            opacity: 1;
            max-height: 5000px; /* Large value to accommodate content */
            visibility: visible;
        }

        /* Editor Styles */
        .code-editor-container {
            position: relative;
            height: 500px;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.5;
            border: 1px solid #374151; /* gray-700 */
            border-radius: 0.5rem;
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
            overflow: hidden;
        }

        .code-editor-container textarea,
        .code-editor-container pre {
            margin: 0;
            padding: 1rem;
            white-space: pre;
            overflow: auto;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box; /* Ensure padding doesn't break layout */
        }

        .code-editor-container textarea {
            z-index: 10;
            background: transparent;
            color: transparent;
            caret-color: white;
            border: none;
            outline: none;
            resize: none;
            -webkit-text-fill-color: transparent;
        }

        .code-editor-container pre {
            z-index: 5;
            pointer-events: none; /* Allows clicks to go to textarea */
        }
        
        /* Syntax Highlighting Colors (CodeHS-inspired) */
        .token-keyword { color: #569cd6; } /* Blue for if, function, etc. */
        .token-string { color: #ce9178; } /* Orange for strings */
        .token-number { color: #b5cea8; } /* Light green for numbers */
        .token-comment { color: #6a9955; } /* Darker green for comments */
        .token-variable { color: #9cdcfe; } /* Light blue for p5, Math */
        .token-function { color: #dcdcaa; } /* Yellow for function names */
        .token-default { color: #d1d5db; } /* Default text color */

        /* AI Modal */
        .modal {
            transition: opacity 0.2s ease-in-out, visibility 0.2s;
        }
        .modal-content {
            transition: transform 0.2s ease-in-out;
        }

        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4f46e5; /* indigo-600 */
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-4xl mx-auto space-y-12">

        <!-- Header -->
        <header class="text-center space-y-4">
            <h1 class="text-5xl font-extrabold text-gray-900 tracking-tight">
                x-Lunar's Projects
            </h1>
            <p class="text-xl text-indigo-600 font-medium">
                All the stuff is here
            </p>
        </header>

        <!-- Main Content Area -->
        <main id="content-area">
            
            <!-- View 1: About Me / Hub (Active by default) -->
            <section id="about-view" class="content-view active">
                <div class="card bg-white p-8 rounded-xl">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">üëã About Me</h2>
                    <div class="text-gray-600 space-y-4">
                        <p>
                            Hello! This is obviously AI-generated, but that's all you're getting for now. enjoy some goofy projects I might make later.
                        </p>
                        <p>
                            Take a look around‚ÄîI hope you find something interesting!
                        </p>
                    </div>
                </div>
            </section>

            <!-- View 2: p5.js Editor -->
            <section id="editor-view" class="content-view">
                <div class="card bg-white p-8 rounded-xl space-y-6">
                    <h2 class="text-3xl font-bold text-gray-800">üé® Creative Coding Sandbox</h2>
                    
                    <!-- Editor UI -->
                    <div class="code-editor-container">
                        <textarea 
                            id="code-input" 
                            spellcheck="false" 
                            autocapitalize="off" 
                            autocorrect="off"
                            aria-label="Code Editor"
                        ></textarea>
                        <pre id="highlight-container"><code id="highlight-output"></code></pre>
                    </div>

                    <!-- Editor Controls -->
                    <div class="flex flex-wrap gap-4">
                        <button id="run-button" class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-200">
                            ‚ñ∂ Run Code
                        </button>
                        <button id="ai-button" class="flex-1 bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-gray-800 transition duration-200">
                            ü§ñ Ask AI
                        </button>
                    </div>

                    <!-- p5.js Output Frame -->
                    <div class="bg-gray-100 border border-gray-300 rounded-lg overflow-hidden">
                        <h3 class="text-lg font-semibold text-gray-700 p-4 bg-gray-200 border-b border-gray-300">Output</h3>
                        <iframe 
                            id="p5-canvas" 
                            title="p5.js Output" 
                            class="w-full h-96"
                            sandbox="allow-scripts"
                        ></iframe>
                    </div>
                </div>
            </section>

            <!-- View 3: Download Portal -->
            <section id="download-view" class="content-view">
                <div class="card bg-white p-8 rounded-xl">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">‚¨áÔ∏è File Download Portal</h2>
                    <div id="download-list" class="space-y-4">
                        <!-- File items will be injected here by JS -->
                    </div>
                </div>
            </section>

        </main>

        <!-- Navigation Buttons Section (Always Visible) -->
        <section class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-800 text-center">My Sites</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <!-- Button 1: p5.js Editor -->
                <button data-view="editor-view" class="nav-button card block bg-white border border-indigo-200 rounded-xl p-6 text-center hover:bg-indigo-50">
                    <div class="text-indigo-600 text-4xl mb-2">üé®</div>
                    <h3 class="text-xl font-semibold text-gray-800">Creative Coding Sandbox</h3>
                    <p class="text-sm text-gray-500 mt-1">Visit my interactive p5.js experiments.</p>
                </button>

                <!-- Button 2: Central Hub -->
                <button data-view="about-view" class="nav-button card block bg-indigo-600 border border-indigo-700 rounded-xl p-6 text-center shadow-lg">
                    <div class="text-white text-4xl mb-2">üè†</div>
                    <h3 class="text-xl font-semibold text-white">Hub</h3>
                    <p class="text-sm text-indigo-200 mt-1">You are here: My main portfolio page.</p>
                </button>

                <!-- Button 3: Download Site -->
                <button data-view="download-view" class="nav-button card block bg-white border border-indigo-200 rounded-xl p-6 text-center hover:bg-indigo-50">
                    <div class="text-indigo-600 text-4xl mb-2">‚¨áÔ∏è</div>
                    <h3 class="text-xl font-semibold text-gray-800">File Download Portal</h3>
                    <p class="text-sm text-gray-500 mt-1">Get the latest file I'm sharing.</p>
                </button>

            </div>
        </section>

    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-50">
        <div class="modal-content transform -translate-y-10 bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-2xl font-bold text-gray-800">ü§ñ Ask AI</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 space-y-4 overflow-y-auto">
                <div>
                    <label for="ai-prompt" class="block text-sm font-medium text-gray-700 mb-1">Your Question:</label>
                    <textarea id="ai-prompt" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Explain this code, or Find the bug"></textarea>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <button id="explain-code-btn" class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200">Explain Code</button>
                    <button id="fix-code-btn" class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200">Fix Code</button>
                    <button id="generate-code-btn" class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200">Generate p5.js sketch</button>
                </div>

                <div id="ai-response-container" class="mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">AI Response:</h4>
                    <div id="ai-loading" class="hidden items-center space-x-2 text-gray-600">
                        <div class="spinner"></div>
                        <span>Thinking...</span>
                    </div>
                    <div id="ai-response" class="prose prose-sm max-w-none bg-gray-50 p-4 rounded-md border border-gray-200 min-h-[100px] overflow-y-auto">
                        Waiting for prompt...
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-4 bg-gray-50 border-t rounded-b-xl">
                <button id="send-ai-request" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-200">
                    Send to AI
                </button>
            </div>
        </div>
    </div>


    <!-- Main Application Logic -->
    <script type="module">
        // --- Gemini API Key ---
        // As per instructions, the API key is left empty.
        // The runtime environment will provide the necessary credentials.
        const GEMINI_API_KEY = "";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;

        // --- File Download Definitions ---
        const downloadFiles = [
            {
                id: "AHKAutoType.ahk",
                name: "AHKAutoType.ahk",
                description: "An AutoHotkey script automaticly typing pasted content like a human.",
                // Content is stored directly here for the download blob
                content: `; --- AHKAutoType.ahk ---
; This is a placeholder AHK script.
; Replace this content with your actual script.

#SingleInstance Force
SetBatchLines, -1

Gui, New, +AlwaysOnTop +ToolWindow -Caption +Border, Gemini AHK
Gui, Color, 303030
Gui, Font, s10, Segoe UI
Gui, Add, Edit, w300 h100 vPrompt gSubmitOnEnter, Type your prompt...
Gui, Add, Button, w100 h30 gSubmit, Submit
Gui, Show, Center, Gemini AHK
return

SubmitOnEnter:
    if (A_GuiEvent = "Normal")
        return
    ; Fallthrough
Submit:
    Gui, Submit, NoHide
    MsgBox, 4096, Sending..., You submitted: %Prompt%
    ; --- Add your API call logic here ---
    Gui, Control, SetText, Edit1, 
return

GuiClose:
    ExitApp
`
            },
            // You can easily add more files here!
            // {
            //     id: "another-file",
            //     name: "example.txt",
            //     description: "This is another example file.",
            //     content: "Hello world!"
            // }
        ];

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initNavigation();
            initEditor();
            initDownloadPortal();
            initAIModal();
            
            // Set default editor text
            const codeInput = document.getElementById('code-input');
            const defaultCode = `// Welcome to the p5.js Sandbox!
// Press "Run Code" to see this in the output window.

function setup() {
  createCanvas(400, 400);
  background(220);
}

function draw() {
  if (mouseIsPressed) {
    fill(255, 0, 0); // Red
    stroke(150, 0, 0);
  } else {
    fill(0, 0, 255); // Blue
    stroke(0, 0, 150);
  }
  ellipse(mouseX, mouseY, 80, 80);
}
`;
            codeInput.value = defaultCode;
            highlightCode(defaultCode);
        });

        // --- 1. Navigation Logic ---
        function initNavigation() {
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const viewId = button.dataset.view;
                    showView(viewId);
                    
                    // Update active button style
                    navButtons.forEach(btn => {
                        btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
                        btn.classList.add('bg-white', 'text-gray-800', 'hover:bg-indigo-50');
                    });
                    if (viewId === 'about-view') {
                        button.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
                        button.classList.remove('bg-white', 'text-gray-800', 'hover:bg-indigo-50');
                    }
                });
            });
        }

        function showView(viewId) {
            const contentArea = document.getElementById('content-area');
            const views = contentArea.querySelectorAll('.content-view');
            
            views.forEach(view => {
                if (view.id === viewId) {
                    // Use setTimeout to allow 'hidden' to apply before adding 'active'
                    setTimeout(() => view.classList.add('active'), 10);
                } else {
                    view.classList.remove('active');
                }
            });
        }

        // --- 2. Editor Logic ---
        function initEditor() {
            const codeInput = document.getElementById('code-input');
            const highlightOutput = document.getElementById('highlight-output');
            const preContainer = document.getElementById('highlight-container');

            // Sync highlighting on input
            codeInput.addEventListener('input', () => {
                const code = codeInput.value;
                highlightCode(code);
            });

            // Sync scrolling
            codeInput.addEventListener('scroll', () => {
                preContainer.scrollTop = codeInput.scrollTop;
                preContainer.scrollLeft = codeInput.scrollLeft;
            });
            
            // Handle Tab key
            codeInput.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    const tab = "  "; // 2 spaces
                    this.value = this.value.substring(0, start) + tab + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + tab.length;
                    highlightCode(this.value); // Re-highlight on tab
                }
            });

            // Run Code Button
            document.getElementById('run-button').addEventListener('click', () => {
                const code = codeInput.value;
                const iframe = document.getElementById('p5-canvas');
                const doc = iframe.contentDocument || iframe.contentWindow.document;

                doc.open();
                doc.write(`
                    <html>
                        <head>
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"><\/script>
                            <style>
                                body { margin: 0; overflow: hidden; }
                                canvas { display: block; }
                            </style>
                        </head>
                        <body>
                            <script>
                                // Basic error handling
                                try {
                                    ${code}
                                } catch (err) {
                                    const p = document.createElement('pre');
                                    p.style.color = 'red';
                                    p.style.fontFamily = 'monospace';
                                    p.style.padding = '10px';
                                    p.textContent = err.toString();
                                    document.body.appendChild(p);
                                }
                            <\/script>
                        </body>
                    </html>
                `);
                doc.close();
            });
        }
        
        // Simple Syntax Highlighter
        function highlightCode(code) {
            const highlightOutput = document.getElementById('highlight-output');
            // Basic regex for keywords
            const keywords = /\b(function|if|else|for|let|const|var|new|return|while|true|false|this)\b/g;
            const p5Keywords = /\b(p5|Math|createCanvas|background|fill|stroke|ellipse|rect|line|point|mouseX|mouseY|width|height|mouseIsPressed|keyIsPressed|keyCode|setup|draw|windowWidth|windowHeight|random|map|abs|cos|sin|tan)\b/g;
            const strings = /(".*?"|'.*?'|`.*?`)/g;
            const numbers = /\b-?\d+(\.\d+)?\b/g;
            const comments = /(\/\/.*$|\/\*[\s\S]*?\*\/)/gm;
            const functionNames = /\b(\w+)\s*(?=\()/g;

            let html = code
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); // Escape HTML

            // Apply syntax highlighting
            // Order matters: comments first, then strings, then keywords
            html = html.replace(comments, '<span class="token-comment">$1</span>');
            html = html.replace(strings, '<span class="token-string">$1</span>');
            html = html.replace(keywords, '<span class="token-keyword">$1</span>');
            html = html.replace(p5Keywords, '<span class="token-variable">$1</span>');
            html = html.replace(functionNames, (match, name) => {
                // Avoid re-coloring keywords
                if (/\b(function|if|else|for|while)\b/.test(name)) {
                    return match;
                }
                return `<span class="token-function">${name}</span>(`;
            });
            html = html.replace(numbers, '<span class="token-number">$1</span>');
            
            // Add a trailing newline to prevent layout shift
            highlightOutput.innerHTML = html + '\n';
        }

        // --- 3. Download Portal Logic ---
        function initDownloadPortal() {
            const downloadList = document.getElementById('download-list');
            if (downloadFiles.length === 0) {
                downloadList.innerHTML = '<p class="text-gray-500">No files available for download right now.</p>';
                return;
            }

            downloadFiles.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-gray-50 border border-gray-200 rounded-lg';
                
                fileElement.innerHTML = `
                    <div class="mb-4 sm:mb-0">
                        <h4 class="text-lg font-semibold text-indigo-700">${file.name}</h4>
                        <p class="text-sm text-gray-600">${file.description}</p>
                    </div>
                    <button data-file-id="${file.id}" class="download-btn w-full sm:w-auto flex-shrink-0 bg-indigo-600 text-white px-5 py-2 rounded-lg font-medium shadow-sm hover:bg-indigo-700 transition duration-200">
                        Download
                    </button>
                `;
                downloadList.appendChild(fileElement);
            });

            // Add event listeners to new buttons
            downloadList.querySelectorAll('.download-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const fileId = button.dataset.fileId;
                    const fileToDownload = downloadFiles.find(f => f.id === fileId);
                    if (fileToDownload) {
                        downloadFileContent(fileToDownload.name, fileToDownload.content);
                    }
                });
            });
        }
        
        function downloadFileContent(filename, content) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- 4. AI Modal Logic ---
        function initAIModal() {
            const modal = document.getElementById('ai-modal');
            const openButton = document.getElementById('ai-button');
            const closeButton = document.getElementById('close-modal');
            const sendButton = document.getElementById('send-ai-request');
            const aiPrompt = document.getElementById('ai-prompt');

            const showModal = () => {
                modal.classList.remove('invisible', 'opacity-0');
                modal.querySelector('.modal-content').classList.remove('-translate-y-10');
            };
            const hideModal = () => {
                modal.classList.add('invisible', 'opacity-0');
                modal.querySelector('.modal-content').classList.add('-translate-y-10');
            };

            openButton.addEventListener('click', showModal);
            closeButton.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) hideModal(); // Close on backdrop click
            });

            // Prompt helper buttons
            document.getElementById('explain-code-btn').addEventListener('click', () => {
                aiPrompt.value = "Please explain what this code does, step by step.";
                aiPrompt.focus();
            });
            document.getElementById('fix-code-btn').addEventListener('click', () => {
                aiPrompt.value = "Find any bugs or errors in this code and provide the corrected version. Only output the corrected code block inside a markdown block.";
                aiPrompt.focus();
            });
            document.getElementById('generate-code-btn').addEventListener('click', () => {
                aiPrompt.value = "Generate a simple p5.js sketch that draws a bouncing ball. Only output the code block inside a markdown block.";
                aiPrompt.focus();
            });

            // Send request to AI
            sendButton.addEventListener('click', callGeminiAPI);
        }
        
        // Exponential backoff for retries
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        // Don't log to console, just retry silently
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            } catch (error) {
                if (retries > 0) {
                    // Don't log to console, just retry silently
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                // Final attempt failed
                console.error("Fetch failed after retries:", error);
                throw error;
            }
        }

        async function callGeminiAPI() {
            const code = document.getElementById('code-input').value;
            const userPrompt = document.getElementById('ai-prompt').value;
            const responseDiv = document.getElementById('ai-response');
            const loadingDiv = document.getElementById('ai-loading');
            const sendButton = document.getElementById('send-ai-request');
            
            if (!userPrompt) {
                responseDiv.textContent = "Please enter a prompt.";
                return;
            }

            loadingDiv.classList.remove('hidden');
            loadingDiv.classList.add('flex');
            responseDiv.textContent = "";
            sendButton.disabled = true;
            sendButton.textContent = "Thinking...";

            const fullPrompt = `
Context: I am working with p5.js and JavaScript in a code editor.

My Code:
\`\`\`javascript
${code}
\`\`\`

My Question:
${userPrompt}

Please provide a helpful response. If you are providing code, wrap it in a markdown block (\`\`\`javascript ... \`\`\`).
            `;

            const payload = {
                contents: [{ parts: [{ text: fullPrompt }] }]
            };

            try {
                const result = await fetchWithBackoff(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    // Simple markdown-to-HTML (for code blocks)
                    let html = text
                        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                        .replace(/\`\`\`javascript\n([\s\S]*?)\n\`\`\`/g, 
                            '<pre class="bg-gray-800 text-white p-3 rounded-md overflow-x-auto"><code>$1</code></pre>')
                        .replace(/\`\`\`\n([\s\S]*?)\n\`\`\`/g, 
                            '<pre class="bg-gray-200 text-gray-800 p-3 rounded-md overflow-x-auto"><code>$1</code></pre>')
                        .replace(/`([^`]+)`/g, '<code class="bg-gray-200 px-1 rounded-sm">$1</code>')
                        .replace(/\n/g, '<br>');
                    responseDiv.innerHTML = html;
                } else {
                    responseDiv.textContent = "Error: Could not get a response from the AI. The response might be empty or blocked.";
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                responseDiv.textContent = `An error occurred: ${error.message}. Check the console for details.`;
            } finally {
                loadingDiv.classList.add('hidden');
                loadingDiv.classList.remove('flex');
                sendButton.disabled = false;
                sendButton.textContent = "Send to AI";
            }
        }

    </script>

</body>
</html>